{% extends "layout/alternating_color_table.html" %}
{% load macros %}
{% loadmacros "macros/pagination.html" %}


{% block pageDropDowns %}
  <a href="{% url 'create_ticket' %}">Create Ticket</a>
{% endblock %}

{% block tableContent %}
 {% comment %} Worked with Gemini to get some code to manage UTC-to-local timezone conversion {% endcomment %}
<script>
  function convertUTCToLocal(utcTime) {
    const utcMillis = new Date(utcTime).getTime();
    const localDate = new Date(utcMillis);
    return localDate.toLocaleString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric',
      hour: 'numeric',
      minute: 'numeric',
      hour12: true
    });
  
  }
</script>
  {% for ticket in page_obj %}
  <tr><td class="post-container">
    <a class="alternating-colors-table-links" href="{% url 'ticket'  ticket.id %}">{{ ticket.summary|escape }}</a>
    <div class="comment-title-underline">
      <div><b> {% if ticket.last_edited_by %} Last Edited By: {{ticket.last_edited_by.name|escape}} {% else %} by {{ticket.author.name|escape}}  {% endif %} on  <span id="ticket-latest-time-{{forloop.counter}}"></span> </b> </div>
      <script>
        var utcTime = new Date('{{ ticket.date|date:"c" }}');
        var localTime = convertUTCToLocal(utcTime);
        document.getElementById('ticket-latest-time-{{forloop.counter}}').textContent = localTime;
      </script>
      {% if ticket.row_action == 'CREATE' %} 
         </div>
      {% elif ticket.row_action == 'EDIT' %}
        <i> (Edited) </i>  </div>
       <div class="comment-title-underline">
                  {% if ticket.is_create_missing %}
                  <p style="color: red;" >  
                    <i> Ticket Creation Date / Original Author not found!</i>
                  </p>
                  {% else %}
                      <p style="color: orange;" > 
                           Originally submitted by {{ticket.author.name |escape}} on  <span id="ticket-creation-time-{{forloop.counter}}"></span>
                     </p>
                     <script>
                      var utcTime = new Date('{{ ticket.create_date|date:"c" }}');
                      var localTime = convertUTCToLocal(utcTime);
                      document.getElementById('ticket-creation-time-{{forloop.counter}}').textContent = localTime;
                    </script>
                  {% endif %}
        </div>
      {% else %}
        </div>
         <div class="comment-title-underline">
            <p style="color: red;" >  
              <i> Warning: This may be the date a ticket was deleted,  before being restored - rather than the last edit date. Your system administrator can check on this</i>
            </p>
        </div>
      {% endif %} 
   
    {% comment %} {% if is_admin %}
    <form method="post" action="{% url 'delete_ticket' ticket.id %}">
      {% csrf_token %}
      <button class="primary-button" style="color: purple;" type="submit" onclick="return confirm('Are you sure you want to delete this ticket?')">Delete</button>
    </form>
    {% endif %} {% endcomment %}
    <p class="">Resolution Status: {{ticket.resolution_status|upper|escape}}</p>
  </td></tr>
  {% endfor %}
  {% use_macro render_pagination page_obj %}




{% endblock %}


